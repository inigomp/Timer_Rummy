<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Temporizador Rummy — Restaurado v18 + Turno grande (con sonidos y paleta dinámica)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#7c63e6;
      --secondary:#5fc3a6;
      --bg-a: #f7f6ff;
      --bg-b: #f1fbf7;
      --card-bg: rgba(255,255,255,0.95);
      --muted:#7f8197;
      --danger:#ef6b6b;
      --glass: rgba(255,255,255,0.6);
      --shadow-strong: 0 18px 40px rgba(34,33,42,0.09);
      --shadow-soft: 0 8px 24px rgba(54,53,74,0.06);
      --radius:18px;
      --gap:12px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --tap-min: 52px; /* minimum comfortable touch target */
      --small-input-w: 56px; /* ancho para inputs de 2 dígitos */
    }

    /* Base + no scroll (v18) */
    html,body{
      height:100%;
      width:100%;
      margin:0;
      padding:0;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(160deg,var(--bg-a), var(--bg-b));
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      color:#201f2a;
    }
    body{
      min-height:100dvh;
      height:100dvh;
      width:100vw;
      overflow:hidden; /* no scroll */
      box-sizing:border-box;
      -webkit-user-select:none;
      touch-action:manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    /* Fullscreen panels (v18) */
    section.panel {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: calc(10px + var(--safe-top)) 12px calc(10px + var(--safe-bottom));
      box-sizing: border-box;
    }
    section.panel.active { display:flex; }

    /* Card container: restore v18 look */
    .card {
      width: min(96vw,480px);
      background: linear-gradient(180deg,var(--card-bg), #fff);
      border-radius: var(--radius);
      box-shadow: var(--shadow-strong);
      padding: clamp(12px, 3.5vw, 20px);
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      align-items: center;
      box-sizing:border-box;
      max-height: calc(100dvh - 1.2rem);
    }

    /* Title: larger for mobile (v18) */
    .title {
      width:100%;
      text-align:center;
      font-weight:900;
      letter-spacing:-0.02em;
      font-size: clamp(1.4rem, 8.5vw, 2.4rem);
      line-height:1;
      margin:0;
      color: transparent;
      background: linear-gradient(90deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .subtitle {
      margin:0;
      color:var(--muted);
      font-weight:600;
      font-size:clamp(0.95rem,4vw,1.05rem);
      text-align:center;
    }

    /* Players inputs: v18 */
    .player-inputs {
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .player-inputs input {
      width:100%;
      box-sizing:border-box;
      padding: clamp(12px, 4vw, 16px);
      border-radius: 12px;
      border: 1px solid rgba(124,99,238,0.16);
      outline:none;
      font-weight:800;
      text-align:center;
      font-size: clamp(1rem, 4vw, 1.12rem);
      background: linear-gradient(180deg,#fff,#fbfbff);
    }

    /* Controls row: v18 */
    .controls {
      width:100%;
      display:flex;
      gap:12px;
      justify-content:center;
    }
    .controls button{
      flex:1;
      min-width:0;
      padding: 0.45rem 0.6rem;
      height: var(--tap-min);
      border-radius:12px;
      border:none;
      background: linear-gradient(90deg, rgba(124,99,238,0.12), rgba(95,195,166,0.06));
      color:var(--primary);
      font-weight:800;
      font-size: clamp(0.98rem,3.8vw,1.06rem);
      box-shadow: var(--shadow-soft);
      cursor:pointer;
    }

    /* Settings / steppers: v18 */
    .settings {
      width:100%;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .settings .field {
      display:flex;
      flex-direction:column;
      gap:8px;
      font-weight:700;
      color:var(--muted);
      font-size:clamp(0.92rem,3.4vw,1rem);
      flex: 1 1 48%;
      min-width: 120px;
      align-items:center;
    }
    .stepper {
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      margin-top:6px;
    }
    .stepper .btn {
      width:44px;
      height:44px;
      min-width:44px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:none;
      background:#fff;
      box-shadow: 0 8px 20px rgba(34,33,42,0.06);
      cursor:pointer;
      font-weight:800;
      color:var(--primary);
      font-size:1.05rem;
    }
    .stepper .btn:active { transform: translateY(1px); }
    .stepper .value {
      width: var(--small-input-w);
      max-width: var(--small-input-w);
      min-width:40px;
      padding:8px 6px;
      border-radius:10px;
      border:1px solid rgba(124,99,238,0.12);
      text-align:center;
      font-weight:800;
      font-size: clamp(0.98rem,3.8vw,1.06rem);
      background: linear-gradient(180deg,#fff,#fbfbff);
      color: #1f1e29;
    }
    .stepper input {
      -moz-appearance: textfield;
      appearance: none;
      border: none;
      background: transparent;
      width:100%;
      text-align:center;
      font-weight:800;
      font-size:inherit;
      outline:none;
    }

    /* Start button — v18 */
    #startBtn {
      width:100%;
      margin-top:4px;
      padding: clamp(12px, 4vw, 18px);
      border-radius:14px;
      border:none;
      color:white;
      font-weight:900;
      font-size: clamp(1.08rem, 4.6vw, 1.4rem);
      background: linear-gradient(90deg,var(--primary),var(--secondary));
      box-shadow: 0 16px 40px rgba(124,99,238,0.12);
      cursor:pointer;
      height: calc(var(--tap-min) + 4px);
    }

    /* ---------------------------
       GAME: replace v18 game with "big button" screen from current version
       --------------------------- */
    .game-full {
      display:flex;
      flex-direction:column;
      align-items:stretch;
      width:100%;
      height: calc(100dvh - 2.2rem);
      gap:12px;
      box-sizing:border-box;
    }

    /* Big turn area: larger button that comes lower (from current version) */
    .big-turn-area {
      flex: 8.5 1 0%;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 6px;
      box-sizing:border-box;
    }
    .big-turn-btn {
      width:100%;
      height: calc(100% - 6px);
      border-radius:18px;
      border:none;
      /* default gradient (will be overridden by JS per player) */
      background: linear-gradient(180deg, var(--primary), #5a47c9);
      color: #fff;
      box-shadow: 0 24px 70px rgba(92,61,224,0.12);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
      padding: 18px;
      transition: background 360ms ease, box-shadow 360ms ease, transform 120ms ease;
    }
    .big-turn-btn:active { transform: translateY(1px); }

    .big-player-name {
      font-weight:900;
      color: #fff;
      font-size: clamp(1.8rem, 9vw, 3.6rem);
      line-height:1.05;
      letter-spacing: 0.6px;
      text-shadow: 0 6px 24px rgba(49,46,78,0.14);
      transform: translateY(-6px);
      margin-bottom: 18px;
    }
    .big-timer {
      font-variant-numeric: tabular-nums;
      font-weight:900;
      color: #fff;
      font-size: clamp(3rem, 14vw, 6rem);
      line-height:1;
      letter-spacing: 2px;
      padding: 8px 14px;
      border-radius:12px;
      background: rgba(255,255,255,0.08);
      box-shadow: inset 0 -6px 18px rgba(0,0,0,0.03);
      min-width: 160px;
      text-align:center;
      transform: translateY(4px);
    }

    /* Bottom actions (pause / end) */
    .bottom-actions {
      flex: 1.5 1 0%;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
      justify-content:flex-end;
    }
    .small-actions {
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:center;
    }
    .small-actions button {
      flex:1;
      padding:12px;
      border-radius:12px;
      border:none;
      font-weight:900;
      font-size: clamp(1rem,4vw,1.12rem);
      cursor:pointer;
      height: calc(var(--tap-min) - 6px);
      box-shadow: var(--shadow-soft);
    }
    #pauseBtn { background: #fff; color:var(--primary); border:1px solid rgba(95,195,166,0.12); }
    #endGameBtn { background: var(--danger); color:white; }

    .info-row { display:flex; justify-content:center; gap:10px; color:var(--muted); font-weight:700; font-size:0.95rem; }

    /* Modal (v18) */
    .modal-bg {
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(34,33,42,0.28); z-index:1200;
      padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bottom));
      box-sizing:border-box;
    }
    .modal-bg.active { display:flex; }
    .modal {
      width: min(92vw,400px);
      background: white;
      border-radius:14px;
      padding:18px;
      box-shadow: 0 22px 60px rgba(34,33,42,0.14);
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }
    .modal p { margin:0; font-weight:900; color:#201f2a; text-align:center; font-size:1rem; }
    .modal-actions { display:flex; gap:12px; width:100%; justify-content:center; }
    .modal-actions button { padding:12px 16px; border-radius:12px; border:none; font-weight:900; cursor:pointer; font-size:1rem; }
    .modal .confirm { background:var(--danger); color:white; }
    .modal .cancel { background:var(--card-bg); color:#201f2a; border:1px solid rgba(34,33,42,0.06); }

    /* ---------- SELECT FIRST: restore v18 styling exactly ---------- */
    #selectFirst .card {
      width: min(92vw,380px);
      padding: 28px 20px;
      border-radius:20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(243,242,255,0.95));
      box-shadow: 0 18px 50px rgba(54,53,74,0.09);
      align-items:stretch;
      animation: pop 0.42s cubic-bezier(.42,1.6,.46,.98);
    }
    @keyframes pop {
      from { transform: translateY(18px) scale(0.96); opacity: 0; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }
    #selectFirst label {
      font-size: 1.12rem;
      font-weight:900;
      color: var(--primary);
      text-align:center;
      margin-bottom:12px;
      display:block;
    }
    .first-player-btns {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .first-player-btns button {
      padding:14px;
      border-radius:12px;
      border:2px solid rgba(124,99,238,0.16);
      background: linear-gradient(90deg,#ede9ff,#e8fff4);
      color: #222;
      font-weight:800;
      font-size:1.02rem;
      cursor:pointer;
      box-shadow: 0 8px 22px rgba(124,99,238,0.06);
    }
    .first-player-btns button:hover { transform: translateY(-3px); }

    @media (max-width:360px){
      .big-player-name { font-size: clamp(1.4rem, 12vw, 2.6rem); }
      .big-timer { font-size: clamp(2rem, 18vw, 4rem); min-width: 110px; padding:6px 10px; }
      .card { padding: 12px; }
      .settings .field { flex: 1 1 100%; } /* stack on tiny devices */
      .stepper .btn { width:40px; height:40px; min-width:40px; border-radius:10px; }
    }
  </style>
</head>
<body>
  <!-- MENU (landing restored from v18) -->
  <section id="menu" class="panel active" aria-hidden="false">
    <div class="card" role="region" aria-label="Menú principal">
      <h1 class="title">Temporizador Rummy</h1>
      <p class="subtitle">Diseñado para móvil — todo a mano</p>

      <div class="player-inputs" id="players" aria-label="Jugadores"></div>

      <div class="controls" role="group" aria-label="Controles jugadores">
        <button id="addPlayer" type="button" aria-label="Añadir jugador">➕ Añadir</button>
        <button id="removePlayer" type="button" aria-label="Eliminar jugador">❌ Eliminar</button>
      </div>

      <div class="settings" aria-label="Ajustes">
        <div class="field">
          <label for="time">Tiempo (min)</label>
          <div class="stepper" data-field="time">
            <button class="btn minus" aria-label="Disminuir tiempo">−</button>
            <div class="value"><input id="time" type="text" inputmode="numeric" pattern="\d{1,2}" value="10" maxlength="2" aria-label="Tiempo por jugador" /></div>
            <button class="btn plus" aria-label="Aumentar tiempo">+</button>
          </div>
        </div>

        <div class="field">
          <label for="penalty">Penalización (seg)</label>
          <div class="stepper" data-field="penalty">
            <button class="btn minus" aria-label="Disminuir penalización">−</button>
            <div class="value"><input id="penalty" type="text" inputmode="numeric" pattern="\d{1,2}" value="10" maxlength="2" aria-label="Penalización en segundos" /></div>
            <button class="btn plus" aria-label="Aumentar penalización">+</button>
          </div>
        </div>
      </div>

      <button id="startBtn" type="button">Comenzar</button>
    </div>
  </section>

  <!-- SELECT FIRST (restored from v18) -->
  <section id="selectFirst" class="panel" aria-hidden="true">
    <div class="card" role="dialog" aria-label="Quién comienza">
      <label>¿Quién comienza?</label>
      <div class="first-player-btns" id="firstPlayerBtns" aria-label="Seleccionar primer jugador"></div>
    </div>
  </section>

  <!-- GAME (big button screen from current version) -->
  <section id="game" class="panel" aria-hidden="true">
    <div class="card" role="region" aria-label="Partida" style="padding:12px;">
      <div class="game-full" id="gameFull">
        <div class="big-turn-area">
          <button id="bigTurnBtn" class="big-turn-btn" aria-label="Pulsar para pasar turno">
            <div class="big-player-name" id="bigPlayerName">Jugador 1</div>
            <div class="big-timer" id="bigTimer">0:00</div>
          </button>
        </div>

        <div class="bottom-actions">
          <div class="small-actions">
            <button id="pauseBtn" type="button" aria-label="Pausa">Pausa</button>
            <button id="endGameBtn" type="button" aria-label="Fin de partida">Fin</button>
          </div>
          <div class="info-row" aria-hidden="true">
            <div id="smallInfo">Pulsa el área principal para pasar turno</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal confirmación (v18) -->
  <div id="confirmModalBg" class="modal-bg" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <p>¿Estás seguro de que quieres abandonar la partida?</p>
      <div class="modal-actions">
        <button class="confirm" id="confirmExitBtn" type="button">Sí, salir</button>
        <button class="cancel" id="cancelExitBtn" type="button">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- JS largely restored from v18, with sounds re-added, prepareTurnTimer and dynamic palette ----------
    // Element references
    const playersDiv = document.getElementById('players');
    const addPlayerBtn = document.getElementById('addPlayer');
    const removePlayerBtn = document.getElementById('removePlayer');
    const startBtn = document.getElementById('startBtn');
    const menu = document.getElementById('menu');
    const selectFirst = document.getElementById('selectFirst');
    const firstPlayerBtns = document.getElementById('firstPlayerBtns');
    const game = document.getElementById('game');
    const bigTurnBtn = document.getElementById('bigTurnBtn');
    const bigPlayerName = document.getElementById('bigPlayerName');
    const bigTimer = document.getElementById('bigTimer');
    const pauseBtn = document.getElementById('pauseBtn');
    const endGameBtn = document.getElementById('endGameBtn');

    // Stepper/input elements
    const timeInput = document.getElementById('time');
    const penaltyInput = document.getElementById('penalty');

    const modalBg = document.getElementById('confirmModalBg');
    const confirmExitBtn = document.getElementById('confirmExitBtn');
    const cancelExitBtn = document.getElementById('cancelExitBtn');

    // State (v18 behavior)
    let players = [];
    let timers = [];
    let currentPlayer = 0;
    let interval = null;
    let paused = false;
    let penaltyTime = 10; // seconds
    let reachedZero = [];

    // Audio state
    let audioCtx = null;
    let alarmPlaying = false;

    // Palette list for big-turn button (each entry: [colorA, colorB])
    const BUTTON_PALETTES = [
      ['#7c63e6','#5fc3a6'],   // original purple -> green
      ['#ff7a7a','#ffb86b'],   // warm red -> orange
      ['#6ec1ff','#6b8cff'],   // light blue -> indigo
      ['#a28bff','#5fc3a6'],   // lilac -> mint
      ['#ff9fe7','#7c63e6'],   // pink -> purple
      ['#66d2a5','#4fb5ff']    // mint -> sky
    ];

    // Audio helpers (reintroduced)
    function ensureAudioContext() {
      if (!audioCtx) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          audioCtx = null;
        }
      }
      return audioCtx;
    }

    function playBellDong() {
      const ctx = ensureAudioContext();
      if (!ctx) return;
      const now = ctx.currentTime;
      const carrier = ctx.createOscillator();
      const gain = ctx.createGain();

      carrier.type = 'sine';
      carrier.frequency.setValueAtTime(880, now);
      carrier.frequency.exponentialRampToValueAtTime(200, now + 1.2);

      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.88, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 1.5);

      carrier.connect(gain);
      gain.connect(ctx.destination);

      carrier.start(now);
      carrier.stop(now + 1.6);
    }

    // Alarm: buzzy / short alarm for when timer reaches zero
    function playAlarm(durationSeconds = 1.0) {
      const ctx = ensureAudioContext();
      if (!ctx) return Promise.resolve();
      if (alarmPlaying) return Promise.resolve();
      alarmPlaying = true;

      const now = ctx.currentTime;
      const oscA = ctx.createOscillator();
      const oscB = ctx.createOscillator();
      const trem = ctx.createOscillator();
      const tremGain = ctx.createGain();
      const gain = ctx.createGain();

      oscA.type = 'square';
      oscA.frequency.setValueAtTime(900, now);
      oscB.type = 'square';
      oscB.frequency.setValueAtTime(1200, now);

      trem.type = 'sine';
      trem.frequency.setValueAtTime(6.5, now);
      tremGain.gain.setValueAtTime(0.5, now);

      trem.connect(tremGain);
      tremGain.connect(gain.gain);

      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.linearRampToValueAtTime(0.9, now + 0.02);
      gain.gain.setValueAtTime(0.9, now + durationSeconds - 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + durationSeconds + 0.03);

      oscA.connect(gain);
      oscB.connect(gain);
      gain.connect(ctx.destination);

      oscA.start(now);
      oscB.start(now);
      trem.start(now);
      oscA.stop(now + durationSeconds + 0.05);
      oscB.stop(now + durationSeconds + 0.05);
      trem.stop(now + durationSeconds + 0.05);

      return new Promise(resolve => {
        setTimeout(() => {
          alarmPlaying = false;
          resolve();
        }, Math.round(durationSeconds * 1000) + 60);
      });
    }

    // Helpers (v18)
    function showPanel(id){
      [menu, selectFirst, game].forEach(p => {
        p.classList.remove('active');
        p.setAttribute('aria-hidden','true');
      });
      const map = { menu, selectFirst, game };
      map[id].classList.add('active');
      map[id].setAttribute('aria-hidden','false');
    }

    function setRandomBackground(){
      const grads = [
        'linear-gradient(160deg,#f7f6ff 0%, #f0fbf7 100%)',
        'linear-gradient(160deg,#fffaf8 0%, #f3fbff 100%)',
        'linear-gradient(160deg,#f9fbff 0%, #f4fff6 100%)'
      ];
      document.body.style.background = grads[Math.floor(Math.random()*grads.length)];
    }

    // Players controls (v18)
    function addPlayerField(){
      if (playersDiv.children.length >= 6) return;
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = `Jugador ${playersDiv.children.length + 1}`;
      playersDiv.appendChild(input);
    }
    function removePlayerField(){
      if (playersDiv.children.length > 2){
        playersDiv.removeChild(playersDiv.lastChild);
      }
    }
    function getPlayerNames(){
      const inputs = Array.from(playersDiv.querySelectorAll('input'));
      if (!inputs.length) return ['Jugador 1','Jugador 2'];
      return inputs.map((el,i) => el.value.trim() || `Jugador ${i+1}`);
    }

    // First player selection (v18)
    function showFirstPlayerSelection(names){
      firstPlayerBtns.innerHTML = '';
      names.forEach((name, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = name;
        btn.addEventListener('click', () => beginGame(i, names));
        firstPlayerBtns.appendChild(btn);
      });
      showPanel('selectFirst');
    }
    function startGameSetup(){
      const names = getPlayerNames();
      if (names.length < 2) return alert('Debes tener al menos 2 jugadores');
      showFirstPlayerSelection(names);
    }

    // Prepare turn timer: if player had timed out (reachedZero) they always start with penaltyTime.
    function prepareTurnTimer(index) {
      if (!timers[index] || timers[index] <= 0) {
        const minutes = Math.max(1, parseInt(cleanNumber(timeInput.value)) || 10);
        timers[index] = minutes * 60;
      }
      if (reachedZero[index]) {
        timers[index] = Number(penaltyTime) || Math.max(1, parseInt(cleanNumber(penaltyInput.value)) || 10);
      }
    }

    // Apply palette to big-turn button based on player index
    function hexToRgba(hex, alpha = 1) {
      // accept shorthand #abc and full #aabbcc
      const h = hex.replace('#','');
      const r = parseInt(h.length === 3 ? h.split('').map(c=>c+c).join('').slice(0,2) : h.slice(0,2), 16);
      const g = parseInt(h.length === 3 ? h.split('').map(c=>c+c).join('').slice(2,4) : h.slice(2,4), 16);
      const b = parseInt(h.length === 3 ? h.split('').map(c=>c+c).join('').slice(4,6) : h.slice(4,6), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function applyButtonPalette(index) {
      if (!bigTurnBtn) return;
      // pick palette by index, fallback to first
      const p = BUTTON_PALETTES[index % BUTTON_PALETTES.length] || BUTTON_PALETTES[0];
      const colorA = p[0];
      const colorB = p[1] || p[0];
      // Apply gradient background
      bigTurnBtn.style.background = `linear-gradient(180deg, ${colorA}, ${colorB})`;
      // Compute subtle colored shadow from primary color
      bigTurnBtn.style.boxShadow = `0 24px 70px ${hexToRgba(colorA,0.12)}`;
    }

    // Game lifecycle (v18 logic, adapted so alarm plays before passing on zero)
    function beginGame(firstIndex, names){
      players = names;
      currentPlayer = firstIndex;
      const minutes = Math.max(1, parseInt(cleanNumber(timeInput.value)) || 10);
      penaltyTime = Math.max(1, parseInt(cleanNumber(penaltyInput.value)) || 10);
      timers = Array(players.length).fill(minutes * 60);
      reachedZero = Array(players.length).fill(false);
      paused = false;
      pauseBtn.textContent = 'Pausa';
      showPanel('game');
      // ensure current player's timer is correct (apply penalty if needed)
      prepareTurnTimer(currentPlayer);
      updateBigButton();
      startTimer();
    }

    function updateBigButton(){
      const name = players[currentPlayer] || ('Jugador ' + (currentPlayer+1));
      bigPlayerName.textContent = name;
      // set button colors according to current player
      applyButtonPalette(currentPlayer);
      renderTime();
    }

    function renderTime(){
      const sec = Math.max(0, timers[currentPlayer] || 0);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      bigTimer.textContent = `${m}:${s < 10 ? '0' + s : s}`;
    }

    function startTimer(){
      clearInterval(interval);
      renderTime();
      interval = setInterval(async () => {
        if (!paused) {
          if (timers[currentPlayer] > 0) {
            timers[currentPlayer]--;
            renderTime();
          } else {
            // time ended: mark, play alarm then pass turn (prevent overlapping alarms)
            if (!alarmPlaying) {
              reachedZero[currentPlayer] = true;
              await playAlarm(1.0);
              // after alarm, advance turn to next player
              endTurn();
            }
          }
        }
      }, 1000);
    }

    function endTurn(){
      // advance to next player, but prepare their timer (apply penalty if they had timed out)
      currentPlayer = (currentPlayer + 1) % players.length;
      prepareTurnTimer(currentPlayer);
      updateBigButton();
      startTimer();
    }

    function togglePause(){
      paused = !paused;
      pauseBtn.textContent = paused ? 'Reanudar' : 'Pausa';
      if (paused) {
        pauseBtn.style.background = 'linear-gradient(90deg,var(--primary),var(--secondary))';
        pauseBtn.style.color = '#fff';
      } else {
        pauseBtn.style.background = '';
        pauseBtn.style.color = '';
      }
    }

    // --- Stepper logic & input constraints (v18) ---
    function cleanNumber(s) {
      return String(s || '').replace(/[^\d]/g,'');
    }
    function clampNumber(n, min=1, max=99) {
      n = Number(n);
      if (Number.isNaN(n)) return min;
      return Math.min(Math.max(n, min), max);
    }
    function setStepperValue(inputEl, value) {
      const v = clampNumber(value, 1, 99);
      inputEl.value = String(v);
    }
    function changeBy(inputEl, delta) {
      let cur = Number(cleanNumber(inputEl.value) || 0);
      if (!cur) cur = 0;
      let next = cur + delta;
      if (next < 1) next = 1;
      if (next > 99) next = 99;
      inputEl.value = String(next);
      inputEl.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function initSteppers() {
      document.querySelectorAll('.stepper').forEach(step => {
        const minus = step.querySelector('.minus');
        const plus = step.querySelector('.plus');
        const input = step.querySelector('input');

        minus.addEventListener('click', () => changeBy(input, -1));
        plus.addEventListener('click', () => changeBy(input, +1));

        input.addEventListener('input', (e) => {
          let s = cleanNumber(input.value);
          if (s.length > 2) s = s.slice(0,2);
          if (s === '') {
            input.value = '';
            return;
          }
          if (Number(s) > 99) s = '99';
          s = String(Number(s));
          input.value = s;
        });

        input.addEventListener('blur', () => {
          if (cleanNumber(input.value) === '') {
            input.value = '1';
          } else {
            let v = Number(cleanNumber(input.value));
            if (v < 1) v = 1;
            if (v > 99) v = 99;
            input.value = String(v);
          }
        });

        input.addEventListener('keydown', (ev) => {
          if (ev.key === 'ArrowUp') { ev.preventDefault(); changeBy(input, +1); }
          if (ev.key === 'ArrowDown') { ev.preventDefault(); changeBy(input, -1); }
        });

        input.addEventListener('paste', (ev) => {
          ev.preventDefault();
          const text = (ev.clipboardData || window.clipboardData).getData('text') || '';
          let s = cleanNumber(text).slice(0,2);
          if (s === '') s = '1';
          if (Number(s) > 99) s = '99';
          input.value = s;
          input.dispatchEvent(new Event('input'));
        });

      });
    }

    // Modal (v18)
    function showEndGameModal(){
      modalBg.classList.add('active');
      modalBg.setAttribute('aria-hidden','false');
      confirmExitBtn.focus();
    }
    function hideEndGameModal(){
      modalBg.classList.remove('active');
      modalBg.setAttribute('aria-hidden','true');
      endGameBtn.focus();
    }
    function confirmEndGame(){
      clearInterval(interval);
      modalBg.classList.remove('active');
      modalBg.setAttribute('aria-hidden','true');
      // Reset to menu (v18 behavior)
      players = [];
      timers = [];
      currentPlayer = 0;
      paused = false;
      pauseBtn.textContent = 'Pausa';
      showPanel('menu');
    }

    // Events (adapted: bigTurnBtn triggers endTurn, with sound)
    addPlayerBtn.addEventListener('click', addPlayerField);
    removePlayerBtn.addEventListener('click', removePlayerField);
    startBtn.addEventListener('click', () => {
      // ensure audio context created on first user gesture
      ensureAudioContext();
      startGameSetup();
    });

    bigTurnBtn.addEventListener('click', async (e) => {
      // ensure audio context exists and give visual feedback
      ensureAudioContext();
      bigTurnBtn.style.transform = 'scale(0.996)';
      setTimeout(()=>{ bigTurnBtn.style.transform = ''; }, 90);

      // Play dong and pass turn
      playBellDong();
      endTurn();
    });

    pauseBtn.addEventListener('click', togglePause);
    endGameBtn.addEventListener('click', showEndGameModal);

    confirmExitBtn.addEventListener('click', confirmEndGame);
    cancelExitBtn.addEventListener('click', hideEndGameModal);
    modalBg.addEventListener('click', (e) => { if (e.target === modalBg) hideEndGameModal(); });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalBg.classList.contains('active')) hideEndGameModal();
    });

    // Init (v18)
    setRandomBackground();
    addPlayerField();
    addPlayerField();
    showPanel('menu');
    initSteppers();

    // Warm audio context on first touch for immediate playback later
    document.addEventListener('touchstart', function createCtxOnce() {
      ensureAudioContext();
      document.removeEventListener('touchstart', createCtxOnce);
    }, { passive:true });

    // Prevent accidental drag selection on mobile
    document.addEventListener('touchstart', ()=>{}, {passive:true});
  </script>
</body>
</html>
