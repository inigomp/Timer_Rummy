<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Temporizador Rummy — Steppers</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#7c63e6;
      --secondary:#5fc3a6;
      --bg-a: #f7f6ff;
      --bg-b: #f1fbf7;
      --card-bg: rgba(255,255,255,0.95);
      --muted:#7f8197;
      --danger:#ef6b6b;
      --glass: rgba(255,255,255,0.6);
      --shadow-strong: 0 18px 40px rgba(34,33,42,0.09);
      --shadow-soft: 0 8px 24px rgba(54,53,74,0.06);
      --radius:18px;
      --gap:12px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --tap-min: 52px; /* minimum comfortable touch target */
      --small-input-w: 56px; /* ancho para inputs de 2 dígitos */
    }

    /* Base + no scroll */
    html,body{
      height:100%;
      width:100%;
      margin:0;
      padding:0;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(160deg,var(--bg-a), var(--bg-b));
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      color:#201f2a;
    }
    body{
      min-height:100dvh;
      height:100dvh;
      width:100vw;
      overflow:hidden; /* no scroll */
      box-sizing:border-box;
      -webkit-user-select:none;
      touch-action:manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    /* Fullscreen panels */
    section.panel {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: calc(10px + var(--safe-top)) 12px calc(10px + var(--safe-bottom));
      box-sizing: border-box;
    }
    section.panel.active { display:flex; }

    /* Card container: reduce top/bottom whitespace and make content larger */
    .card {
      width: min(96vw,480px);
      background: linear-gradient(180deg,var(--card-bg), #fff);
      border-radius: var(--radius);
      box-shadow: var(--shadow-strong);
      padding: clamp(12px, 3.5vw, 20px);
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      align-items: center;
      box-sizing:border-box;
      max-height: calc(100dvh - 1.2rem);
    }

    /* Title: larger for mobile */
    .title {
      width:100%;
      text-align:center;
      font-weight:900;
      letter-spacing:-0.02em;
      font-size: clamp(1.4rem, 8.5vw, 2.4rem);
      line-height:1;
      margin:0;
      color: transparent;
      background: linear-gradient(90deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .subtitle {
      margin:0;
      color:var(--muted);
      font-weight:600;
      font-size:clamp(0.95rem,4vw,1.05rem);
      text-align:center;
    }

    /* Players inputs: make inputs taller and clearer */
    .player-inputs {
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .player-inputs input {
      width:100%;
      box-sizing:border-box;
      padding: clamp(12px, 4vw, 16px);
      border-radius: 12px;
      border: 1px solid rgba(124,99,238,0.16);
      outline:none;
      font-weight:800;
      text-align:center;
      font-size: clamp(1rem, 4vw, 1.12rem);
      background: linear-gradient(180deg,#fff,#fbfbff);
    }

    /* Controls row: larger touch targets */
    .controls {
      width:100%;
      display:flex;
      gap:12px;
      justify-content:center;
    }
    .controls button{
      flex:1;
      min-width:0;
      padding: 0.45rem 0.6rem;
      height: var(--tap-min);
      border-radius:12px;
      border:none;
      background: linear-gradient(90deg, rgba(124,99,238,0.12), rgba(95,195,166,0.06));
      color:var(--primary);
      font-weight:800;
      font-size: clamp(0.98rem,3.8vw,1.06rem);
      box-shadow: var(--shadow-soft);
      cursor:pointer;
    }

    /* Settings: stacked on narrow screens */
    .settings {
      width:100%;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .settings .field {
      display:flex;
      flex-direction:column;
      gap:8px;
      font-weight:700;
      color:var(--muted);
      font-size:clamp(0.92rem,3.4vw,1rem);
      flex: 1 1 48%;
      min-width: 120px;
      align-items:center; /* center label and stepper horizontally */
    }

    /* Small input replaced with stepper (centered under label) */
    .stepper {
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      margin-top:6px;
    }
    .stepper .btn {
      width:44px;
      height:44px;
      min-width:44px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:none;
      background:#fff;
      box-shadow: 0 8px 20px rgba(34,33,42,0.06);
      cursor:pointer;
      font-weight:800;
      color:var(--primary);
      font-size:1.05rem;
    }
    .stepper .btn:active { transform: translateY(1px); }
    .stepper .value {
      width: var(--small-input-w);
      max-width: var(--small-input-w);
      min-width:40px;
      padding:8px 6px;
      border-radius:10px;
      border:1px solid rgba(124,99,238,0.12);
      text-align:center;
      font-weight:800;
      font-size: clamp(0.98rem,3.8vw,1.06rem);
      background: linear-gradient(180deg,#fff,#fbfbff);
      color: #1f1e29;
    }
    /* allow editing the value directly (numeric keyboard) */
    .stepper input {
      -moz-appearance: textfield;
      appearance: none;
      border: none;
      background: transparent;
      width:100%;
      text-align:center;
      font-weight:800;
      font-size:inherit;
      outline:none;
    }

    /* Start button — larger and prominent */
    #startBtn {
      width:100%;
      margin-top:4px;
      padding: clamp(12px, 4vw, 18px);
      border-radius:14px;
      border:none;
      color:white;
      font-weight:900;
      font-size: clamp(1.08rem, 4.6vw, 1.4rem);
      background: linear-gradient(90deg,var(--primary),var(--secondary));
      box-shadow: 0 16px 40px rgba(124,99,238,0.12);
      cursor:pointer;
      height: calc(var(--tap-min) + 4px);
    }

    /* Select-first tweaks */
    #selectFirst .card { align-items:stretch; gap:14px; }
    .first-player-btns { display:flex; flex-direction:column; gap:12px; }
    .first-player-btns button {
      padding:14px;
      height: var(--tap-min);
      border-radius:12px;
      border:2px solid rgba(124,99,238,0.22);
      background: linear-gradient(90deg,#f3f0ff,#effff7);
      font-weight:900;
      font-size: clamp(1rem,4.2vw,1.12rem);
      cursor:pointer;
    }

    /* Game UI */
    .game-card {
      width: min(96vw,440px);
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:stretch;
      padding: clamp(14px, 4vw, 20px);
    }
    .turn-row {
      width:100%;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:flex-start;
    }
    .avatar {
      width:64px;
      height:64px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(135deg,var(--primary),var(--secondary));
      color:white;
      font-weight:900;
      font-size:1.1rem;
      box-shadow: 0 10px 26px rgba(124,99,238,0.12);
      flex-shrink:0;
    }
    .turn-text {
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .turn-label { font-weight:700; font-size:clamp(0.95rem,3.6vw,1.08rem); color:var(--muted); }
    .turn-name { font-weight:900; font-size:clamp(1.2rem,6.2vw,1.8rem); color:var(--primary); }

    /* Timer */
    #timer {
      font-variant-numeric:tabular-nums;
      font-weight:900;
      font-size: clamp(2rem, 14vw, 4.8rem);
      padding: clamp(12px, 4.6vw, 24px) clamp(18px,6vw,40px);
      border-radius:14px;
      background: linear-gradient(180deg,#fff,#fbfbff);
      box-shadow: 0 18px 48px rgba(49,46,78,0.08);
      color:#1f1e29;
      text-align:center;
      min-width:140px;
      align-self:center;
    }

    .game-btns { width:100%; display:flex; gap:12px; }
    .game-btns button {
      flex:1;
      padding:14px;
      border-radius:12px;
      border:none;
      font-weight:900;
      font-size: clamp(1rem,4vw,1.12rem);
      cursor:pointer;
      box-shadow: var(--shadow-soft);
      height: calc(var(--tap-min) + 2px);
    }
    #endTurnBtn{ background: linear-gradient(90deg,var(--primary),var(--secondary)); color:white; }
    #pauseBtn{ background: var(--card-bg); color:var(--primary); border:1px solid rgba(95,195,166,0.12); }

    #endGameBtn {
      width:100%;
      padding:12px;
      border-radius:12px;
      border:none;
      background:var(--danger);
      color:white;
      font-weight:900;
      font-size: clamp(1rem,4vw,1.12rem);
      cursor:pointer;
      height: calc(var(--tap-min) + 2px);
    }

    /* Modal */
    .modal-bg {
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(34,33,42,0.28); z-index:1200;
      padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bottom));
      box-sizing:border-box;
    }
    .modal-bg.active { display:flex; }
    .modal {
      width: min(92vw,400px);
      background: white;
      border-radius:14px;
      padding:18px;
      box-shadow: 0 22px 60px rgba(34,33,42,0.14);
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }
    .modal p { margin:0; font-weight:900; color:#201f2a; text-align:center; font-size:1rem; }
    .modal-actions { display:flex; gap:12px; width:100%; justify-content:center; }
    .modal-actions button { padding:12px 16px; border-radius:12px; border:none; font-weight:900; cursor:pointer; font-size:1rem; }
    .modal .confirm { background:var(--danger); color:white; }
    .modal .cancel { background:var(--card-bg); color:#201f2a; border:1px solid rgba(34,33,42,0.06); }

    @media (max-width:360px){
      .avatar{ width:56px; height:56px; font-size:1rem; }
      #timer{ font-size: clamp(1.6rem, 16vw, 3.4rem); padding:10px 18px; }
      .card { padding: 12px; }
      .settings .field { flex: 1 1 100%; } /* stack on tiny devices */
      .stepper .btn { width:40px; height:40px; min-width:40px; border-radius:10px; }
    }
  </style>
</head>
<body>
  <!-- MENU -->
  <section id="menu" class="panel active" aria-hidden="false">
    <div class="card" role="region" aria-label="Menú principal">
      <h1 class="title">Temporizador Rummy</h1>
      <p class="subtitle">Diseñado para móvil — todo a mano</p>

      <div class="player-inputs" id="players" aria-label="Jugadores"></div>

      <div class="controls" role="group" aria-label="Controles jugadores">
        <button id="addPlayer" type="button" aria-label="Añadir jugador">➕ Añadir</button>
        <button id="removePlayer" type="button" aria-label="Eliminar jugador">❌ Eliminar</button>
      </div>

      <div class="settings" aria-label="Ajustes">
        <div class="field">
          <label for="time">Tiempo (min)</label>
          <div class="stepper" data-field="time">
            <button class="btn minus" aria-label="Disminuir tiempo">−</button>
            <div class="value"><input id="time" type="text" inputmode="numeric" pattern="\d{1,2}" value="10" maxlength="2" aria-label="Tiempo por jugador" /></div>
            <button class="btn plus" aria-label="Aumentar tiempo">+</button>
          </div>
        </div>

        <div class="field">
          <label for="penalty">Penalización (seg)</label>
          <div class="stepper" data-field="penalty">
            <button class="btn minus" aria-label="Disminuir penalización">−</button>
            <div class="value"><input id="penalty" type="text" inputmode="numeric" pattern="\d{1,2}" value="10" maxlength="2" aria-label="Penalización en segundos" /></div>
            <button class="btn plus" aria-label="Aumentar penalización">+</button>
          </div>
        </div>
      </div>

      <button id="startBtn" type="button">Comenzar</button>
    </div>
  </section>

  <!-- SELECT FIRST -->
  <section id="selectFirst" class="panel" aria-hidden="true">
    <div class="card" role="dialog" aria-label="Quién comienza">
      <label style="font-weight:900; color:var(--primary); font-size:clamp(1rem,4.5vw,1.2rem);">¿Quién comienza?</label>
      <div class="first-player-btns" id="firstPlayerBtns" aria-label="Seleccionar primer jugador"></div>
    </div>
  </section>

  <!-- GAME -->
  <section id="game" class="panel" aria-hidden="true">
    <div class="game-card card" role="region" aria-label="Partida">
      <div class="turn-row" role="status" aria-live="polite">
        <div class="avatar" id="turnAvatar">J</div>
        <div class="turn-text">
          <div class="turn-label">Turno de:</div>
          <div class="turn-name" id="turnName">Jugador 1</div>
        </div>
      </div>

      <div id="timer" aria-live="polite">0:00</div>

      <div class="game-btns">
        <button id="endTurnBtn" type="button">Fin de turno</button>
        <button id="pauseBtn" type="button">Pausa</button>
      </div>

      <button id="endGameBtn" type="button">Fin de partida</button>
    </div>
  </section>

  <!-- Modal confirmación -->
  <div id="confirmModalBg" class="modal-bg" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <p>¿Estás seguro de que quieres abandonar la partida?</p>
      <div class="modal-actions">
        <button class="confirm" id="confirmExitBtn" type="button">Sí, salir</button>
        <button class="cancel" id="cancelExitBtn" type="button">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // Element references
    const playersDiv = document.getElementById('players');
    const addPlayerBtn = document.getElementById('addPlayer');
    const removePlayerBtn = document.getElementById('removePlayer');
    const startBtn = document.getElementById('startBtn');
    const menu = document.getElementById('menu');
    const selectFirst = document.getElementById('selectFirst');
    const firstPlayerBtns = document.getElementById('firstPlayerBtns');
    const game = document.getElementById('game');
    const turnName = document.getElementById('turnName');
    const turnAvatar = document.getElementById('turnAvatar');
    const timerEl = document.getElementById('timer');
    const endTurnBtn = document.getElementById('endTurnBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const endGameBtn = document.getElementById('endGameBtn');

    // Stepper/input elements
    const timeInput = document.getElementById('time');
    const penaltyInput = document.getElementById('penalty');

    const modalBg = document.getElementById('confirmModalBg');
    const confirmExitBtn = document.getElementById('confirmExitBtn');
    const cancelExitBtn = document.getElementById('cancelExitBtn');

    // State
    let players = [];
    let timers = [];
    let currentPlayer = 0;
    let interval = null;
    let paused = false;
    let penaltyTime = 10;
    let reachedZero = [];

    // Helpers
    function showPanel(id){
      [menu, selectFirst, game].forEach(p => {
        p.classList.remove('active');
        p.setAttribute('aria-hidden','true');
      });
      const map = { menu, selectFirst, game };
      map[id].classList.add('active');
      map[id].setAttribute('aria-hidden','false');
    }

    function setRandomBackground(){
      const grads = [
        'linear-gradient(160deg,#f7f6ff 0%, #f0fbf7 100%)',
        'linear-gradient(160deg,#fffaf8 0%, #f3fbff 100%)',
        'linear-gradient(160deg,#f9fbff 0%, #f4fff6 100%)'
      ];
      document.body.style.background = grads[Math.floor(Math.random()*grads.length)];
    }

    // Players controls
    function addPlayerField(){
      if (playersDiv.children.length >= 6) return;
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = `Jugador ${playersDiv.children.length + 1}`;
      playersDiv.appendChild(input);
    }
    function removePlayerField(){
      if (playersDiv.children.length > 2){
        playersDiv.removeChild(playersDiv.lastChild);
      }
    }
    function getPlayerNames(){
      const inputs = Array.from(playersDiv.querySelectorAll('input'));
      if (!inputs.length) return ['Jugador 1','Jugador 2'];
      return inputs.map((el,i) => el.value.trim() || `Jugador ${i+1}`);
    }

    // First player selection
    function showFirstPlayerSelection(names){
      firstPlayerBtns.innerHTML = '';
      names.forEach((name, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = name;
        btn.addEventListener('click', () => beginGame(i, names));
        firstPlayerBtns.appendChild(btn);
      });
      showPanel('selectFirst');
    }
    function startGameSetup(){
      const names = getPlayerNames();
      if (names.length < 2) return alert('Debes tener al menos 2 jugadores');
      showFirstPlayerSelection(names);
    }

    // Game lifecycle
    function beginGame(firstIndex, names){
      players = names;
      currentPlayer = firstIndex;
      const minutes = Math.max(1, parseInt(cleanNumber(timeInput.value)) || 10);
      penaltyTime = Math.max(1, parseInt(cleanNumber(penaltyInput.value)) || 10);
      timers = Array(players.length).fill(minutes * 60);
      reachedZero = Array(players.length).fill(false);
      paused = false;
      pauseBtn.textContent = 'Pausa';
      showPanel('game');
      updateTurnVisual();
      startTimer();
    }

    function updateTurnVisual(){
      const name = players[currentPlayer] || ('Jugador ' + (currentPlayer+1));
      const initials = name.split(' ').map(n => n[0] || '').slice(0,2).join('').toUpperCase();
      turnAvatar.textContent = initials || 'J';
      turnName.textContent = name;
    }

    function startTimer(){
      clearInterval(interval);
      renderTime();
      interval = setInterval(() => {
        if (!paused) {
          if (timers[currentPlayer] > 0) {
            timers[currentPlayer]--;
            renderTime();
          } else {
            reachedZero[currentPlayer] = true;
            endTurn();
          }
        }
      }, 1000);
    }

    function renderTime(){
      const sec = Math.max(0, timers[currentPlayer] || 0);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      timerEl.textContent = `${m}:${s < 10 ? '0' + s : s}`;
    }

    function endTurn(){
      currentPlayer = (currentPlayer + 1) % players.length;
      updateTurnVisual();
      startTimer();
    }

    function togglePause(){
      paused = !paused;
      pauseBtn.textContent = paused ? 'Reanudar' : 'Pausa';
      if (paused) {
        pauseBtn.style.background = 'linear-gradient(90deg,var(--primary),var(--secondary))';
        pauseBtn.style.color = '#fff';
      } else {
        pauseBtn.style.background = '';
        pauseBtn.style.color = '';
      }
    }

    // --- Stepper logic & input constraints ---
    function cleanNumber(s) {
      return String(s || '').replace(/[^\d]/g,'');
    }

    function clampNumber(n, min=1, max=99) {
      n = Number(n);
      if (Number.isNaN(n)) return min;
      return Math.min(Math.max(n, min), max);
    }

    function setStepperValue(inputEl, value) {
      const v = clampNumber(value, 1, 99);
      inputEl.value = String(v);
    }

    function changeBy(inputEl, delta) {
      let cur = Number(cleanNumber(inputEl.value) || 0);
      if (!cur) cur = 0;
      let next = cur + delta;
      if (next < 1) next = 1;
      if (next > 99) next = 99;
      inputEl.value = String(next);
      // visually update also (input is visible)
      inputEl.dispatchEvent(new Event('input', { bubbles: true }));
    }

    // Attach handlers for each stepper area (plus/minus + direct input)
    function initSteppers() {
      document.querySelectorAll('.stepper').forEach(step => {
        const minus = step.querySelector('.minus');
        const plus = step.querySelector('.plus');
        const input = step.querySelector('input');

        minus.addEventListener('click', () => changeBy(input, -1));
        plus.addEventListener('click', () => changeBy(input, +1));

        // numeric keyboard + filter, limit to 2 digits and 1..99
        input.addEventListener('input', (e) => {
          let s = cleanNumber(input.value);
          if (s.length > 2) s = s.slice(0,2);
          if (s === '') {
            input.value = '';
            return;
          }
          if (Number(s) > 99) s = '99';
          // avoid leading zeros
          s = String(Number(s));
          input.value = s;
        });

        input.addEventListener('blur', () => {
          // on blur, ensure there's a valid number
          if (cleanNumber(input.value) === '') {
            setStepperValue(input, 1);
          } else {
            setStepperValue(input, clampNumber(input.value,1,99));
          }
        });

        // prevent arrow keys changing page scroll etc., and allow arrow increments
        input.addEventListener('keydown', (ev) => {
          if (ev.key === 'ArrowUp') { ev.preventDefault(); changeBy(input, +1); }
          if (ev.key === 'ArrowDown') { ev.preventDefault(); changeBy(input, -1); }
        });

        // sanitize paste
        input.addEventListener('paste', (ev) => {
          ev.preventDefault();
          const text = (ev.clipboardData || window.clipboardData).getData('text') || '';
          let s = cleanNumber(text).slice(0,2);
          if (s === '') s = '1';
          if (Number(s) > 99) s = '99';
          input.value = s;
          input.dispatchEvent(new Event('input'));
        });

      });
    }

    // Modal: timer keeps running while modal shown
    function showEndGameModal(){
      modalBg.classList.add('active');
      modalBg.setAttribute('aria-hidden','false');
      confirmExitBtn.focus();
    }
    function hideEndGameModal(){
      modalBg.classList.remove('active');
      modalBg.setAttribute('aria-hidden','true');
      endGameBtn.focus();
    }
    function confirmEndGame(){
      clearInterval(interval);
      modalBg.classList.remove('active');
      modalBg.setAttribute('aria-hidden','true');
      // Reset state and go back to menu, keep existing input fields
      players = [];
      timers = [];
      currentPlayer = 0;
      paused = false;
      pauseBtn.textContent = 'Pausa';
      showPanel('menu');
    }

    // Events
    addPlayerBtn.addEventListener('click', addPlayerField);
    removePlayerBtn.addEventListener('click', removePlayerField);
    startBtn.addEventListener('click', startGameSetup);
    endTurnBtn.addEventListener('click', endTurn);
    pauseBtn.addEventListener('click', togglePause);
    endGameBtn.addEventListener('click', showEndGameModal);

    confirmExitBtn.addEventListener('click', confirmEndGame);
    cancelExitBtn.addEventListener('click', hideEndGameModal);
    modalBg.addEventListener('click', (e) => { if (e.target === modalBg) hideEndGameModal(); });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalBg.classList.contains('active')) hideEndGameModal();
    });

    // Init
    setRandomBackground();
    addPlayerField();
    addPlayerField();
    showPanel('menu');
    initSteppers();

    // Prevent accidental drag selection on mobile
    document.addEventListener('touchstart', ()=>{}, {passive:true});
  </script>
</body>
</html>
